#!/usr/bin/env slang

import libScript.OS;


private float ERROR const   = 10f;
private float WARNING const = 20f;

private string COLOR;
private string DATE;
private string MSG_SHORT;
private string PROBE const = "free";


public void Main( int, string )
{
    COLOR = process();
    DATE  = strftime( "%Y-%m-%d %H:%M:%S %Z" );

    print( streval( "{{{PROBE}}} {{{COLOR}}} {{{DATE}}} {{{MSG_SHORT}}}" ) );
}

private string process()
{
    var result = OS.free( "-m" );

    var mem const = result[ 1 ];

    var buffered = cast<float>( mem[ 5 ] );
    var free     = cast<float>( mem[ 3 ] );
    var total    = cast<float>( mem[ 1 ] );

    var percentFree = ( free + buffered ) / total * 100f;

    if ( percentFree < ERROR ) {
        MSG_SHORT = streval( "ERROR: {{{ERROR}}}% or less of memory free" );
        return "red";
    }
    else if ( percentFree < WARNING ) {
        MSG_SHORT = streval( "WARNING: {{{WARNING}}}% or less of memory free" );
        return "yellow";
    }
    else {
        MSG_SHORT = streval( "OK: {{{percentFree}}}% of free/buffered memory" );
    }

    return "green";
}

